'''
Github: https://github.com/0xEmbo/Pentesting-Tools
Usage:
   Example: sudo python3 p0r75c4nn3r.py -H 127.0.0.1 -u      --> Scans top ports (Default) (-u To skip host discovery)
   Example: sudo python3 p0r75c4nn3r.py -H target.com -v     --> Scans top ports (Default) (-v To enable verbose mode)
   Example: sudo python3 p0r75c4nn3r.py -H 192.168.1.0/24 -p 80 -w output.txt    --> (-w To write the output to a file)
   Example: sudo python3 p0r75c4nn3r.py -H 192.168.1.1-100 -p 22,80,139,443,445
   Example: sudo python3 p0r75c4nn3r.py -H 127.0.0.1 -p 1-1000
'''

from scapy.all import *
import argparse, colorama, threading, time, socket, ipaddress
from termcolor import colored
from queue import Queue
from collections import defaultdict


socket.setdefaulttimeout(0.2)
colorama.init()
lock = threading.Lock()
open_ports = []
up_hosts = []
start_time = time.time()
q = Queue()
qq = Queue()
hosts_ports = defaultdict(list)


print(' ')
print(colored("    ____   ___      _____ ____       _  _               _____        ", 'green', attrs=['bold']))
print(colored("   |  _ \ / _ \ _ _|___  | ___|  ___| || |  _ __  _ __ |___ / _ __   ", 'green', attrs=['bold']))
print(colored("   | |_) | | | | '__| / /|___ \ / __| || |_| '_ \| '_ \  |_ \| '__|  ", 'green', attrs=['bold']))
print(colored("   |  __/| |_| | |   / /  ___) | (__|__   _| | | | | | |___) | |     ", 'green', attrs=['bold']))
print(colored("   |_|    \___/|_|  /_/  |____/ \___|  |_| |_| |_|_| |_|____/|_|     ", 'green', attrs=['bold']))
print(' ')
print(colored('\t\t\tBy: ', 'green', attrs=['bold']) + colored('0xEmbo', 'yellow', attrs=['bold']))
print(colored('\t\t\tGithub: ', 'green', attrs=['bold']) + colored('https://github.com/0xEmbo/', 'yellow', attrs=['bold']))
print('\r\n')

parser = argparse.ArgumentParser(description='- A simple port scanner that scans multiple hosts concurrenty.', usage='sudo python3 p0r75c4nn3r.py -H <host(s)> -p <port(s)> OPTIONS')
parser.add_argument('-H', '--hosts', metavar='', required=True, help='Host(s) to scan [e.g: -H 127.0.0.1 , -H 192.168.1.0/24 , -H 192.168.1.1-50]')
parser.add_argument('-p', '--ports', metavar='', help='Port(s) to scan [e.g: -p80 , -p1-1000 , -p22,139,445,80]')
parser.add_argument('-u', '--up', help='Treat all hosts as online (Skip host discovery)', action='store_true')
parser.add_argument('-v', '--verbose', help='Verbose mode', action='store_true')
parser.add_argument('-w', '--write', metavar='', help='Save output to a file')
args = parser.parse_args()

top_ports = list(map(int,"20,21,22,23,25,47,53,69,80,110,113,123,135,137,138,139,143,161,179,194,201,311,389,427,443,445,465,500,513,514,515,530,548,554,563,587,593,601,631,636,660,674,691,694,749,751,843,873,901,902,903,987,990,992,993,994,995,1000,1167,1234,1433,1434,1521,1528,1723,1812,1813,2000,2049,2375,2376,2077,2078,2082,2083,2086,2087,2095,2096,2222,2433,2483,2484,2638,3000,3260,3283,3306,3389,3478,3690,4000,5000,5432,5433,6000,6667,7000,8000,8080,8443,8880,8888,9000,9001,9418,9998,27017,27018,27019,28017,32400".split(',')))

if not args.up:
   print(colored('[*] Checking if host(s) are up...', 'yellow'))

def is_up():
   while True:
      host = qq.get()
      icmp = sr1(IP(dst=host)/ICMP(),timeout=1,verbose=0)
      if icmp:
         up_hosts.append(host)
         with lock:
            print(colored(f'[+] {host} is up', 'green'))
      else:
         pass
      qq.task_done()


def portscanner(host):
   while not q.empty():
      port = q.get()
      s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
      try:
         con = s.connect((host, port))
         if args.verbose:
            with lock:
               print(colored(f'\r[+] Discovered open port {port}/tcp on {host}', 'green'))
         hosts_ports[host].append(port)
         open_ports.append(port)
         con.close()
      except:
         pass
      q.task_done()

def ports_to_scan():
   if not args.ports:
      for port in top_ports:
         q.put(port)
   elif '-' in args.ports:
      ports = list(map(int,args.ports.split('-')))
      for port in range(ports[0], ports[1]+1):
         q.put(port)
   elif ',' in args.ports:
      ports = list(map(int, args.ports.split(',')))
      for port in ports:
         q.put(port)
   else:
      q.put(int(args.ports))


if '/' in args.hosts:
   for host in ipaddress.IPv4Network(args.hosts):
      try:
         socket.gethostbyname(str(host))
      except:
         with lock:
            print(colored(f'[-] Unable to resolve hostname for {host}', 'red'))
         continue

      qq.put(str(host))

elif '-' in args.hosts:
   ip = args.hosts[:args.hosts.rfind('.')+1]
   for i in range(int(args.hosts.split('.')[3].split('-')[0]), int(args.hosts.split('.')[3].split('-')[1])):
      try:
         socket.gethostbyname(ip + str(i))
      except:
         with lock:
            print(colored(f'[-] Unable to resolve hostname for {ip + str(i)}', 'red'))
            continue
      qq.put(ip + str(i))

else:
   try:
      socket.gethostbyname(args.hosts)
   except:
      with lock:
         print(colored(f'[-] Unable to resolve hostname for {args.hosts}', 'red'))
      exit(0)
   qq.put(args.hosts)


if not args.up:
   for _ in range(100):
      tt = threading.Thread(target=is_up)
      tt.daemon = True
      tt.start()
   qq.join()
   print(colored('[*] Port Scanning Started...', 'yellow'))
   ports_to_scan()
   for ip in up_hosts:
      for _ in range(200):
         t = threading.Thread(target=portscanner, args=(ip,))
         t.daemon = True
         t.start()
      q.join()
      ports_to_scan()

else:
   print(colored('[*] Skipping host discovery...', 'yellow'))
   print(colored('[*] Port Scanning Started...', 'yellow'))
   ports_to_scan()
   while not qq.empty():
      up_hosts.append(qq.get())
      qq.task_done()
   for ip in up_hosts:
      for _ in range(200):
         t = threading.Thread(target=portscanner, args=(ip,))
         t.daemon = True
         t.start()
      q.join()
      ports_to_scan()


end_time = time.time()

for hosts,ports in hosts_ports.items():
   print(colored(f'\r\n[*] Scan report for {hosts}', 'yellow'))
   print(colored('[*] PORT   SERVICE', 'yellow'))
   for port in ports:
      try:
         print(colored(f'[+] {port}/tcp   {socket.getservbyport(port,"tcp")}', 'green'))
      except:
         print(colored(f'[+] {port}/tcp   Unknown', 'green'))
   print('\r\n')


if args.write:
   output = open(args.write, 'w')
   for hosts,ports in hosts_ports.items():
      output.write(f'[*] Scan report for {hosts}\n')
      output.write('\n[*] PORT   SERVICE\n')
      for port in ports:
         try:
            output.write(f'[+] {port}/tcp   {socket.getservbyport(port,"tcp")}\n')
         except:
            output.write(f'[+] {port}/tcp   Unknown\n')
      output.write('\r\n')

   output.write(f'[*] Scan finished in {end_time-start_time} second(s)')
   output.close()

print(colored(f'\r\n[*] Scan finished in {end_time-start_time} second(s)', 'yellow'))
