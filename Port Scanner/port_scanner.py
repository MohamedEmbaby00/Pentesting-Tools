'''
Github: https://github.com/MohamedEmbaby00/Pentesting-Tools
Usage:
	Example: python3 port_scanner.py -H 127.0.0.1 -u		--> Scans top ports (Default) (-u To skip host discovery)
	Example: python3 port_scanner.py -H target.com -v		--> Scans top ports (Default) (-v To enable verbose mode)
	Example: python3 port_scanner.py -H 127.0.0.1 -p 80
	Example: python3 port_scanner.py -H 127.0.0.1 -p 22,80,139,443,445
	Example: python3 port_scanner.py -H 127.0.0.1 -p 1-1000
'''

from scapy.all import *
import argparse, concurrent.futures, colorama
from time import time
from socket import gethostbyname
from termcolor import colored


colorama.init()
sp = RandShort()
open_ports = []
start_time = time()


parser = argparse.ArgumentParser(description='========== Simple Port Scanner ==========', usage='python3 port_scanner.py -H <host> -p <port(s)>')
parser.add_argument('-H', '--host', metavar='', required=True, help='Host to scan')
parser.add_argument('-p', '--ports', metavar='', help='Port(s) to scan {example: -p80 // -p1-1000 /// -p22,139,445,80}')
parser.add_argument('-u', '--up', help='Treat host as online (Skip host discovery)', action='store_true')
parser.add_argument('-v', '--verbose', help='Verbose mode', action='store_true')
parser.add_argument('-w', '--write', metavar='', help='Save output to a file')
args = parser.parse_args()

top_ports = list(map(int,"20,21,22,23,25,47,53,69,80,110,113,123,135,137,138,139,143,161,179,194,201,311,389,427,443,445,465,500,513,514,515,530,548,554,563,587,593,601,631,636,660,674,691,694,749,751,843,873,901,902,903,987,990,992,993,994,995,1000,1167,1234,1433,1434,1521,1528,1723,1812,1813,2000,2049,2375,2376,2077,2078,2082,2083,2086,2087,2095,2096,2222,2433,2483,2484,2638,3000,3260,3283,3306,3389,3478,3690,4000,5000,5432,5433,6000,6667,7000,8000,8080,8443,8880,8888,9000,9001,9418,9998,27017,27018,27019,28017,32400".split(',')))

try:
	host = gethostbyname(args.host)
except:
	print(colored('[-] Unable to resolve hostname!', 'red'))
	exit(0)


def is_up():
	print(colored('[*] Checking if host is up...', 'yellow'))
	icmp = sr1(IP(dst=host)/ICMP(),timeout=5,verbose=0)
	if icmp:
		print(colored(f'[+] {args.host} is up', 'green'))
		return True
	else:
		print(colored(f'[-] {args.host} is down', 'red'))
		exit(0)
		return False

def port_scanner(p):
	reply = sr1(IP(dst=args.host)/TCP(sport=sp,dport=p,flags='S'),timeout=.2,verbose=0)
	if reply != None:
		if reply[TCP].flags == 18:
			if args.verbose:
				print(colored(f'\r[+] Discovered open port {p}/tcp on {args.host}', 'green'))
			open_ports.append(p)
		else:
			pass

def scanning_options():
	print(colored('[*] Port Scanning Started...', 'yellow'))
	if not args.ports:
		with concurrent.futures.ThreadPoolExecutor() as executor:
			executor.map(port_scanner, top_ports)

	elif (('-' not in args.ports) and (',' not in args.ports)):
		port_scanner(int(args.ports))

	elif '-' in args.ports:
		ports = list(map(int,args.ports.split('-')))
		with concurrent.futures.ThreadPoolExecutor() as executor:
			executor.map(port_scanner, range(ports[0], ports[1]+1))

	elif ',' in args.ports:
		ports = list(map(int, args.ports.split(',')))
		with concurrent.futures.ThreadPoolExecutor() as executor:
			executor.map(port_scanner, ports)	
	else:
		print(colored('[-] Syntax Error!', 'red'))


if not args.up:
	if is_up():
		scanning_options()
elif args.up:
	print(colored('[*] Skipped host discovery', 'yellow'))
	scanning_options()

print(colored('\r\n[*] PORT   STATE', 'yellow'))
for port in open_ports:
	print(colored(f'[+] {port}/tcp   open', 'green'))

end_time = time()

if args.write:
	output = open(args.write, 'a')
	output.write(f'[*] Scan report for {args.host}\n')
	output.write('[*] PORT   STATE\n')
	for port in open_ports:
		output.write(f'[+] {port}/tcp   open\n')
	output.write(f'\n[*] Scan finished in {end_time-start_time} second(s)')
	output.close()

print(colored(f'\r\n[*] Scan finished in {end_time-start_time} second(s)', 'yellow'))
